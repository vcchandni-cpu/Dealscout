document.getElementById('search-form').addEventListener('submit', function(event) {
    // Prevent the default form submission that causes a page reload
    event.preventDefault(); 

    // 1. Get the product name from the input field
    const query = document.getElementById('product-query').value;

    // Clear previous results
    const tableBody = document.querySelector('#price-table tbody');
    tableBody.innerHTML = '<tr><td colspan="3">Searching...</td></tr>';

    // 2. Send the query to your Python backend (Flask API route)
    // NOTE: In a real Flask app, you'd define a route like '/api/search' 
    // that calls the PriceScout class
    fetch(`/api/search?product=${encodeURIComponent(query)}`) 
        .then(response => response.json())
        .then(data => {
            // 3. Clear the 'Searching...' message
            tableBody.innerHTML = ''; 

            if (data.error) {
                tableBody.innerHTML = `<tr><td colspan="3">${data.error}</td></tr>`;
                return;
            }

            // 4. Iterate over the sorted results and build the table rows
            data.forEach((item, index) => {
                const row = tableBody.insertRow();

                // Style the best deal row
                if (index === 0) {
                    row.classList.add('best-deal');
                }

                // Platform Cell
                row.insertCell().textContent = item.platform;

                // Price Cell
                row.insertCell().textContent = `$${item.price.toFixed(2)}`;

                // Action Cell (The Affiliate Link)
                const actionCell = row.insertCell();
                const link = document.createElement('a');
                link.href = item.affiliate_link; // Use the link generated by Python
                link.textContent = index === 0 ? 'GO TO BEST DEAL' : 'Go to Store';
                link.target = '_blank'; // Opens in a new tab
                actionCell.appendChild(link);
            });
        })
        .catch(error => {
            console.error('Fetch error:', error);
            tableBody.innerHTML = '<tr><td colspan="3">Error fetching data. Try again.</td></tr>';
        });
});
